<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Punky Community</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Vast+Shadow&display=swap" rel="stylesheet" />

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  background: black;
  font-family: 'Press Start 2P', cursive;
  color: white;
  overflow: hidden;
}
.container {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 20px;
}
.paper {
  background: rgba(0,0,0,.8);
  border: 2px solid #f0f;
  padding: 20px;
  max-width: 400px;
  margin: auto;
}
button {
  margin: 8px;
  padding: 10px 20px;
  background: #f0f;
  color: white;
  border: none;
  cursor: pointer;
  font-family: 'Press Start 2P';
}
.menu {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
}
.menu-item {
  background: #ff0;
  color: black;
  padding: 10px;
  margin: 5px;
  cursor: pointer;
}
#signup-message { color: lime; margin-top: 10px; }
</style>
</head>

<body>

<div class="container">

  <!-- AUTH BUTTONS -->
  <div id="auth-buttons">
    <button onclick="showSignUp()">Sign Up</button>
    <button onclick="showSignIn()">Log In</button>
  </div>

  <!-- AUTH FORM -->
  <div class="paper" id="auth-form" style="display:none;">
    <h2 style="font-family:Vast Shadow">Welcome Punk ðŸ¤˜</h2>

    <input id="auth-email" type="email" placeholder="Email"><br><br>
    <input id="auth-password" type="password" placeholder="Password"><br>

    <button onclick="submitAuth()">Submit</button>
    <button onclick="cancelAuth()">Cancel</button>

    <p onclick="resetPassword()" style="cursor:pointer;color:#0ff;">
      Forgot password?
    </p>

    <div id="signup-message"></div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="paper" id="main-content" style="display:none;">
    <h2 id="chat-header">Loading...</h2>
    <div id="chat"></div>

    <div class="menu" id="menu"></div>
    <div id="synopsis"></div>

    <button onclick="logout()">Log Out</button>
  </div>
</div>

<script>
/* ---------------- SUPABASE INIT ---------------- */

const supabaseUrl = 'https://mtkujqqzddyxtjeszuzz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10a3VqcXF6ZGR5eHRqZXN6dXp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MjU4NDMsImV4cCI6MjA4NDIwMTg0M30.bImNbkfZkrfZJhCLlfKTxg8-RQUZWTfZovwN0z3aQjE';

const supabase = window.supabase = supabase.createClient(
  supabaseUrl,
  supabaseKey
);

let authMode = null;
let currentUser = null;

/* ---------------- UI HELPERS ---------------- */

function showSignUp() {
  authMode = 'signup';
  toggleAuth(true);
}

function showSignIn() {
  authMode = 'signin';
  toggleAuth(true);
}

function toggleAuth(show) {
  authForm.style.display = show ? 'block' : 'none';
  authButtons.style.display = show ? 'none' : 'block';
  signupMessage.innerText = '';
}

function cancelAuth() {
  toggleAuth(false);
  authMode = null;
}

function showLoginOnly() {
  authButtons.innerHTML = `<button onclick="showSignIn()">Log In</button>`;
}

/* ---------------- AUTH LOGIC ---------------- */

async function submitAuth() {
  const email = authEmail.value.trim();
  const password = authPassword.value.trim();

  if (!email || !password) {
    alert('Email and password required');
    return;
  }

  if (authMode === 'signup') {
    const { error } = await supabase.auth.signUp({ email, password });

    if (error) return alert(error.message);

    signupMessage.innerText = 'Signup successful! ðŸŽ‰ Please log in.';
    showLoginOnly();
  }

  if (authMode === 'signin') {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) return handleLoginError(error);

    currentUser = data.user;
    loadApp();
  }
}

function handleLoginError(error) {
  let msg = 'Login failed.';
  if (error.message.includes('Invalid')) {
    msg = 'Wrong email or password.';
  }
  if (error.message.includes('confirmed')) {
    msg = 'Please confirm your email first.';
  }
  alert(msg);
}

/* ---------------- PASSWORD RESET ---------------- */

async function resetPassword() {
  const email = authEmail.value.trim();
  if (!email) return alert('Enter email first.');

  const { error } = await supabase.auth.resetPasswordForEmail(email);
  if (error) alert(error.message);
  else alert('Password reset email sent.');
}

/* ---------------- SESSION RESTORE ---------------- */

supabase.auth.onAuthStateChange((_event, session) => {
  if (session?.user) {
    currentUser = session.user;
    loadApp();
  }
});

/* ---------------- APP LOAD ---------------- */

function loadApp() {
  authForm.style.display = 'none';
  authButtons.style.display = 'none';
  mainContent.style.display = 'block';

  chatHeader.innerText = `Welcome ${currentUser.email}`;
  chat.innerHTML = `ðŸ¤˜ You made it into the Punk Community.`;
}

/* ---------------- LOGOUT ---------------- */

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

/* ---------------- MENU ---------------- */

const menuItems = [
  { title:'ABOUT', synopsis:'Punk roots', link:'https://en.wikipedia.org/wiki/Punk_rock' },
  { title:'MUSIC', synopsis:'Punk tunes', link:'https://punknews.org' },
  { title:'SHOP', synopsis:'Punk gear', link:'https://punkclothing.com' }
];

menuItems.forEach(item => {
  const div = document.createElement('div');
  div.className = 'menu-item';
  div.innerText = item.title;
  div.onclick = () => {
    synopsis.innerHTML = `
      <p>${item.synopsis}</p>
      <a href="${item.link}" target="_blank" style="color:#f0f;">Visit</a>
    `;
  };
  menu.appendChild(div);
});
</script>

</body>
</html>
